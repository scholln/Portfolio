---
title: "The_RMD_MonteCarlo"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)

library(readxl)

library(shiny)

library(broom)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
Synthetic_Data_Small_Coverage_10082021 <- read_excel("Synthetic Data Small - Coverage 10082021.xlsx")






outpatient <- read_excel("Synthetic Data Small - Facility Outpatient 10082021.xlsx")

coverage <- read_excel("Synthetic Data Small - Coverage 10082021.xlsx")


facility_inpatient <- read_excel("Synthetic Data Small - Facility Inpatient 10082021.xlsx")

member <- read_excel("Synthetic Data Small - Member 10082021.xlsx")

patient <- read_excel("Synthetic Data Small - Patient 10082021.xlsx")

pharmacy <- read_excel("Synthetic Data Small - Pharmacy 10082021.xlsx")

professional <- read_excel("Synthetic Data Small - Professional 10082021.xlsx")


Test <- full_join(outpatient, coverage, by = "Member ID (secure)")

Test <- full_join(outpatient, coverage, by = "Member ID (secure)")

View(Test)
Synthetic <- full_join(outpatient, coverage, facility_inpatient, member, patient, pharmacy, professional, by = "Member ID (secure)")

Synthetic <- full_join(outpatient, coverage, facility_inpatient, member, by = "Member ID (secure)")

View(facility_inpatient)

Synthetic <- full_join(outpatient, coverage, member, by = "Member ID (secure)")

View(Synthetic)
half <- full_join(facility_inpatient, patient, pharmacy, professional, by = "Member ID (secure)")

half <- full_join(patient, pharmacy, professional, by = "Member ID (secure)")

inpatient <- read_excel("Synthetic Data Small - Facility Inpatient 10082021.xlsx")


full_synthetic <- full_join(half, Synthetic, inpatient, by = "Member ID (secure)")

View(full_synthetic)
View(coverage)
View(patient)
```

So all of this above is what I like to call "the great join" where I downloaded all of the excel files into R, and then proceeded to join them together to bring all the data into one table.

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


```{r Now its time to get funky}

ICD_10_accuracy <- full_synthetic %>%
  select('Member ID (secure)', memb_brth_dt.x, memb_gender_cd.x, patient_name, state_nm, allwd_amt.x, princ_icd10_diag_cd, admtng_icd10_diag_cd)
  
view(ICD_10_accuracy)

```


```{r function to check accurarcy}

# accuracy <- function(data_set, col_name1, col_name2)
#   {
#   
#   if((data_set$col_name1) == (data_set$col_name2)){
#     
#     mutate(data_set, Accurate = 1)
#   }
#   else{
#     mutate(data_set, Accurate = 0)
#   }
#   
#     
#   
#   
# }
# 
# accuracy(ICD_10_accuracy, princ_icd10_diag_cd, admtng_icd10_diag_cd)


ICD_10_accuracy %>%
  mutate(accurate = if_else(princ_icd10_diag_cd == admtng_icd10_diag_cd, 1, 0)) %>%
  filter(!is.na(accurate))


```

Holy smokes that was a huge bust, there were no cases where the admitting ICD10 and the diagnosis ICD10 where the same.  Either they had an NA or did not match.  Important to note because we can see the admitting diagnosis does not equal the original diagnosis.



```{r We get up and try again}

Amount_allowed <- full_synthetic %>%
  select(princ_icd10_diag_cd, "Member ID (secure)",  memb_brth_dt.x, memb_gender_cd.x, patient_name, state_nm, allwd_amt.x, sbmtd_amt.x, copay_coin_amt, coin_amt, ded_amt)
  

Diag_amount_allowed <- Amount_allowed %>%
  group_by(princ_icd10_diag_cd) %>%
  summarise(mean = mean(allwd_amt.x, na.rm = TRUE), sd = sd(allwd_amt.x, na.rm = TRUE), n = n())

```




```{r function time}


## I found that this produced a huge dataset that was unusable due to too many NA's.  Many entries in the diagnosis had nothing but NA's, we couldn't get an accurate picture of it with so many entries with NA's.  That, and some entries had only one value to return.

map2(Diag_amount_allowed$mean, Diag_amount_allowed$sd, ~rnorm(100, .x, .y))
```


```{r Let's do some calculations}
allwd_amnt_tibble <- full_synthetic2 %>%
  summarise(mean = mean(allwd_amt.x, na.rm = TRUE), sd = sd(allwd_amt.x, na.rm = TRUE))

sbmtd_amnt_tibble <- full_synthetic2 %>%
  summarise(mean = mean(sbmtd_amt.x, na.rm = TRUE), sd = sd(sbmtd_amt.x, na.rm = TRUE))

copay_coin_amnt_tibble <- full_synthetic2 %>%
  summarise(mean = mean(copay_coin_amt, na.rm = TRUE), sd = sd(copay_coin_amt, na.rm = TRUE))

coin_amnt_tibble <- full_synthetic2 %>%
  summarise(mean = mean(coin_amt, na.rm = TRUE), sd = sd(coin_amt, na.rm = TRUE))

ded_amnt_tibble <- full_synthetic2 %>%
  summarise(mean = mean(ded_amt, na.rm = TRUE), sd = sd(coin_amt, na.rm = TRUE))


```


```{r Simulation and what not}

Allwd_amnt_column <- rnorm(1000, mean = allwd_amnt_tibble$mean, sd = allwd_amnt_tibble$sd)
Sbmtd_amnt_column <- rnorm(1000, mean = sbmtd_amnt_tibble$mean, sd = allwd_amnt_tibble$sd)
Copay_coin_amnt_column <- rnorm(1000, mean = copay_coin_amnt_tibble$mean, sd = copay_coin_amnt_tibble$sd)
Coin_amnt_column <- rnorm(1000, mean = coin_amnt_tibble$mean, sd = coin_amnt_tibble$sd)
Ded_amnt_column <- rnorm(1000, mean = ded_amnt_tibble$mean, sd = ded_amnt_tibble$sd)

Linear_frame <- tibble(Allwd_amnt_column, Sbmtd_amnt_column, Copay_coin_amnt_column, Coin_amnt_column, Ded_amnt_column)

```


```{r Let's change gears and do MLM}

model_for_ded <- lm(Ded_amnt_column~Allwd_amnt_column+Sbmtd_amnt_column+Copay_coin_amnt_column+Coin_amnt_column, Linear_frame)

```

```{r Print the model to check}

summary(model_for_ded)

```

```{r Now we try to get a nested data frame}


Nested_amount_allowed2 <- Amount_allowed %>%
  group_by(state_nm) %>%
  nest()

```

```{r Now we get the formula to each state}

Nested_amount_allowed2 <- Nested_amount_allowed2 %>%
  mutate(model = map(data, ~lm(model_for_ded, data = .)))

```

```{r Time to unnest this mess}

Nested_amount_allowed <- Nested_amount_allowed %>%
  unnest(data)

```

This is the part where I am running into trouble.  It is showing all the linear equations as the same.  It is showing them as the original "model_for_ded".  Please let me know your thoughts on this

```{r Getting the coefficients for even more formulas}

print(Nested_amount_allowed2[[3]][[1]])
print(Nested_amount_allowed2[[3]][[2]])
print(Nested_amount_allowed2[[3]][[3]])
print(Nested_amount_allowed2[[3]][[4]])
print(Nested_amount_allowed2[[3]][[5]])

```





```{r Let's try a formula}

deductible <- function(allwd_amt, sbtd_amt, copay_coin_amt, coin_amt){
  
  deductible = 22.95425 + (allwd_amt * 804.88442) + (sbtd_amt * -784.75091) + (copay_coin_amt * -0.02612) + (coin_amt * 0.72997)
  
  return(deductible)
}

deductible_New_York <- function(allwd_amt, sbtd_amt, copay_coin_amt, coin_amt){
  
  deductible =29.804432 + (allwd_amt *  0.002503) + (sbtd_amt * -0.001106) + (copay_coin_amt * 0.002440) + (coin_amt * 0.042544)
  
  return(deductible)
}

deductible_Illinois <- function(allwd_amt, sbtd_amt, copay_coin_amt, coin_amt){
  
  deductible = 29.804432 + (allwd_amt *  724.14601) + (sbtd_amt * -706.02762) + (copay_coin_amt * -0.03729) + (coin_amt * 1.09490)
  
  return(deductible)
}

deductible_Arizona <- function(allwd_amt, sbtd_amt, copay_coin_amt, coin_amt){
  
  deductible = 0.1280909 + (allwd_amt *  148.8685) + (sbtd_amt * -6.6826764) + (copay_coin_amt * -0.0004278) + (coin_amt * 0.0026185)
  
  return(deductible)
}

deductible_Texas <- function(allwd_amt, sbtd_amt, copay_coin_amt, coin_amt){
  
  deductible = 56.5658 + (allwd_amt *  148.8685) + (sbtd_amt * -145.1775) + (copay_coin_amt * -0.0570) + (coin_amt * 0.3753)
  
  return(deductible)
}

deductible_California <- function(allwd_amt, sbtd_amt, copay_coin_amt, coin_amt){
  
  deductible = 76.8014 + (allwd_amt *  4243.6768) + (sbtd_amt * -4137.5039) + (copay_coin_amt * -0.4802) + (coin_amt * -0.2482)
  
  return(deductible)
}

```

```{r Testing it out}



deductible(5000, 2000, 200, 500)


```

```{r We are going to explore further into the Original dataset}

Location <- full_synthetic2 %>%
  select(memb_brth_dt.x, memb_gender_cd.x, memb_rltnshp_cd, patient_name, state_nm, county_nm, country, address, mbrs_crnt_prim_zip_cd, "Member ID (secure)")

```


```{r Seeing patient location}

Location %>%
  group_by(state_nm) %>%
  ggplot(aes(county_nm, fill = state_nm)) +
  geom_bar()



```
We can also see the majority of entries are from Illinois and the next being Texas.


I now have curiosity from Cook county claims.  Let's explore

```{r}

Location_Amount <- full_join(Amount_allowed, Location, BY = "Member ID (secure)")
## okay so, we ran into an issue here where I got "Error: cannot allocate vector of size 6.3 Gb" So we are gonna do a different approach...

```

```{r New way or the highway}
Location_amount <- full_synthetic2 %>%
  select(princ_icd10_diag_cd, "Member ID (secure)",  memb_brth_dt.x, memb_gender_cd.x, patient_name, state_nm, allwd_amt.x, sbmtd_amt.x, copay_coin_amt, coin_amt, ded_amt, state_nm, county_nm, country, address, mbrs_crnt_prim_zip_cd)
```

```{r Time for some numerical summaries}

Location_amount %>%
  group_by(princ_icd10_diag_cd) %>%
  filter(county_nm == "COOK") %>%
  summarise(n = n()) %>%
  arrange(desc(n))
#This shows us that in the county with the most claims, the most common diagnosis was N18.6.  This code is for end-stage renal disease.

```
```{r Exploring N18.6}

Location_amount %>%
  filter(princ_icd10_diag_cd == "N18.6")


```





